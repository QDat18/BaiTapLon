<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Thanh toán - Anh Em Rọt Store</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <style>
    :root {
      --primary: #000000;
      --secondary: #ff3a2d;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --accent: #0071e3;
    }

    body {
      background-color: #f5f5f7;
      color: var(--dark);
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      overflow-x: hidden;
    }

    .checkout-container {
      padding: 2rem 0;
    }

    .breadcrumb {
      background: transparent;
      padding: 0.5rem 0;
      margin-bottom: 1.5rem;
    }

    .breadcrumb-item a {
      color: var(--gray);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .breadcrumb-item a:hover {
      color: var(--accent);
    }

    .checkout-header {
      font-size: 2rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 1.5rem;
    }

    .checkout-form, .order-summary {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      margin-bottom: 1.5rem;
    }

    .form-label {
      font-weight: 600;
      color: var(--dark);
    }

    .form-control {
      border-radius: 8px;
      border: 1px solid #dee2e6;
      padding: 0.75rem;
    }

    .form-control:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 0.2rem rgba(0, 113, 227, 0.25);
    }

    .payment-method {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .payment-option {
      padding: 1rem;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
    }

    .payment-option:hover, .payment-option.active {
      border-color: var(--accent);
      background: #f1f3f5;
    }

    .payment-option i {
      font-size: 1.25rem;
      margin-right: 1rem;
    }

    .payment-option.active:before {
      content: '\f058';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: var(--accent);
      margin-right: 0.5rem;
    }

    .order-summary h4 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 1.5rem;
    }

    .order-items {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1.5rem;
    }

    .order-item {
      display: flex;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid #dee2e6;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .order-item-image {
      width: 60px;
      height: 60px;
      object-fit: contain;
      border-radius: 8px;
    }

    .order-item-details {
      flex: 1;
    }

    .order-item-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--dark);
    }

    .order-item-info {
      font-size: 0.9rem;
      color: var(--gray);
    }

    .order-item-price {
      font-weight: 600;
      color: var(--secondary);
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      font-size: 1rem;
    }

    .summary-divider {
      margin: 0.75rem 0;
      border-top: 1px dashed #dee2e6;
    }

    .summary-label {
      color: var(--gray);
    }

    .summary-value {
      font-weight: 600;
      color: var(--dark);
    }

    .coupon-applied {
      background-color: #e8f4fe;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .coupon-applied i {
      color: var(--accent);
      margin-right: 0.5rem;
    }

    .coupon-discount {
      color: var(--accent);
      font-weight: 600;
    }

    .summary-total {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--secondary);
    }

    .btn-place-order {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: var(--secondary);
      color: white;
      border: none;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-place-order:hover {
      background: #e02b20;
      transform: translateY(-2px);
    }

    .btn-place-order:disabled {
      background: #f1a8a3;
      cursor: not-allowed;
      transform: none;
    }

    .btn-shop-now {
      padding: 10px 24px;
      border-radius: 8px;
      background: var(--secondary);
      color: white;
      border: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-shop-now:hover {
      background: #e02b20;
      color: white;
      transform: translateY(-2px);
    }

    .empty-checkout {
      text-align: center;
      padding: 3rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .empty-checkout i {
      font-size: 3rem;
      color: var(--gray);
      margin-bottom: 1rem;
    }

    .empty-checkout p {
      font-size: 1.1rem;
      color: var(--gray);
      margin-bottom: 1.5rem;
    }

    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1050;
    }

    .form-feedback {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .shipping-options {
      margin-top: 1rem;
    }

    .shipping-option {
      padding: 1rem;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-bottom: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .shipping-option.active {
      border-color: var(--accent);
      background: #f1f3f5;
    }

    .shipping-option-radio {
      margin-right: 1rem;
    }

    .shipping-option-info {
      flex: 1;
    }

    .shipping-option-price {
      font-weight: 600;
    }

    .customer-info {
      border-top: 1px solid #dee2e6;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
    }

    .order-success {
      text-align: center;
      padding: 3rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .order-success i {
      font-size: 4rem;
      color: #28a745;
      margin-bottom: 1.5rem;
    }

    .order-success h2 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 1rem;
    }

    .order-success p {
      font-size: 1.1rem;
      color: var(--gray);
      margin-bottom: 2rem;
    }

    .order-id {
      font-weight: 600;
      color: var(--accent);
    }

    .btn-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      border: 0.125rem solid currentColor;
      border-right-color: transparent;
      animation: spinner-border .75s linear infinite;
    }

    @keyframes spinner-border {
      to { transform: rotate(360deg); }
    }

    .form-select {
      border-radius: 8px;
      border: 1px solid #dee2e6;
      padding: 0.75rem;
    }

    .form-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 0.2rem rgba(0, 113, 227, 0.25);
    }

    @media (max-width: 768px) {
      .checkout-header {
        font-size: 1.75rem;
      }

      .checkout-form, .order-summary {
        padding: 1.5rem;
      }

      .order-item-image {
        width: 50px;
        height: 50px;
      }

      .order-item-title {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <!--  <div id="navbar-placeholder"></div>  -->

  <!-- Checkout Content -->
  <div class="container checkout-container animate__animated animate__fadeIn">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html"><i class="fas fa-home"></i></a></li>
        <li class="breadcrumb-item"><a href="cart.html">Giỏ hàng</a></li>
        <li class="breadcrumb-item active" aria-current="page">Thanh toán</li>
      </ol>
    </nav>

    <h1 class="checkout-header">Thanh toán</h1>

    <div id="checkoutContent"></div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <!-- Footer -->
  <!-- <div id="footer-placeholder"></div> -->

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="scripts/loadcontent.js"></script>
  <script>
    // Khai báo biến toàn cục
    let orderData = {
      items: [],
      subtotal: 0,
      shipping: 0,
      discount: 0,
      total: 0,
      coupon: null
    };

    // Lưu phương thức thanh toán được chọn
    let selectedPaymentMethod = 'cod';
    let selectedShippingMethod = 'standard';
    let orderPlaced = false;

    document.addEventListener('DOMContentLoaded', function() {
      // Navbar scroll effect
      window.addEventListener('scroll', function() {
        if (window.scrollY > 50) {
          document.querySelector('.navbar')?.classList.add('scrolled');
        } else {
          document.querySelector('.navbar')?.classList.remove('scrolled');
        }
      });

      // Load checkout items
      loadCheckoutItems();

      // Lấy thông tin khách hàng từ localStorage (nếu có)
      const savedCustomerInfo = JSON.parse(localStorage.getItem('customerInfo')) || {};
      setTimeout(() => {
        const fullNameInput = document.getElementById('fullName');
        if (fullNameInput && savedCustomerInfo.fullName) {
          fullNameInput.value = savedCustomerInfo.fullName;
        }
        
        const phoneInput = document.getElementById('phone');
        if (phoneInput && savedCustomerInfo.phone) {
          phoneInput.value = savedCustomerInfo.phone;
        }
        
        const emailInput = document.getElementById('email');
        if (emailInput && savedCustomerInfo.email) {
          emailInput.value = savedCustomerInfo.email;
        }

        const addressInput = document.getElementById('address');
        if (addressInput && savedCustomerInfo.address) {
          addressInput.value = savedCustomerInfo.address;
        }

        const citySelect = document.getElementById('city');
        if (citySelect && savedCustomerInfo.city) {
          citySelect.value = savedCustomerInfo.city;
        }
      }, 500);

      // Auto-fill coupon if available from cart
      const couponFromCart = localStorage.getItem('couponCode');
      if (couponFromCart) {
        orderData.coupon = {
          code: couponFromCart,
          type: localStorage.getItem('couponType') || 'percent',
          value: parseInt(localStorage.getItem('couponValue') || '0')
        };
      }
    });

    /**
     * Tải các sản phẩm từ giỏ hàng cho trang thanh toán
     */
    function loadCheckoutItems() {
      const checkoutContent = document.getElementById('checkoutContent');
      
      // Cố gắng lấy dữ liệu giỏ hàng từ checkoutCart hoặc cart
      let cart = JSON.parse(localStorage.getItem('checkoutCart')) || [];
      if (cart.length === 0) {
        cart = JSON.parse(localStorage.getItem('cart')) || [];
      }

      if (cart.length === 0) {
        checkoutContent.innerHTML = `
          <div class="empty-checkout animate__animated animate__fadeIn">
            <i class="fas fa-shopping-cart"></i>
            <h4>Không có sản phẩm để thanh toán!</h4>
            <p>Hãy thêm sản phẩm vào giỏ hàng trước khi tiến hành thanh toán.</p>
            <a href="product.html" class="btn btn-shop-now">
              <i class="fas fa-shopping-bag me-2"></i>Mua sắm ngay
            </a>
          </div>
        `;
        return;
      }

      // Hiển thị loading spinner
      checkoutContent.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
          </div>
          <p class="mt-2">Đang tải thông tin đơn hàng...</p>
        </div>
      `;

      // Load product data to use for cart
      fetch('data/product.json')
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! Status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          // Flatten all products from all categories for easier lookup
          const allProducts = data.categories.flatMap(category => category.products);
          
          // Chuyển đổi cart thành cấu trúc đơn hàng đầy đủ
          processCartItems(cart, allProducts);
          
          // Hiển thị giao diện thanh toán
          renderCheckoutUI();
        })
        .catch(err => {
          console.error('Error loading product data:', err);
          checkoutContent.innerHTML = `
            <div class="alert alert-danger" role="alert">
              <i class="fas fa-exclamation-circle me-2"></i> Có lỗi xảy ra khi tải dữ liệu sản phẩm. Vui lòng thử lại sau.
              <button class="btn btn-sm btn-outline-danger ms-3" onclick="loadCheckoutItems()">Thử lại</button>
            </div>
          `;
        });
    }

    /**
     * Xử lý dữ liệu giỏ hàng thành thông tin đơn hàng
     */
    function processCartItems(cart, allProducts) {
      orderData.items = [];
      orderData.subtotal = 0;

      cart.forEach(item => {
        // Find product by id
        const product = allProducts.find(p => p.id === item.productId);
        
        if (!product) {
          console.error(`Product with id ${item.productId} not found!`);
          return;
        }
        
        // Get variant information
        const variant = product.variants[item.variantIndex] || product.variants[0];
        if (!variant) {
          console.error(`Variant not found for product ${product.name}!`);
          return;
        }

        // Xử lý thông tin biến thể (capacity, type, color)
        const variantInfo = variant.capacity || variant.type || '';
        const variantColor = variant.colors ? (item.colorIndex !== undefined ? variant.colors[item.colorIndex] : variant.colors[0]) : '';
        
        // Fix: Xử lý giá đúng cách khi có giá khuyến mãi
        const price = variant.salePrice || variant.price;
        const originalPrice = variant.salePrice ? variant.price : null;
        const itemSubtotal = price * (item.quantity || 1);
        
        // Thêm vào danh sách sản phẩm
        orderData.items.push({
          id: product.id,
          name: product.name,
          image: product.imageUrl,
          variant: variantInfo,
          color: variantColor,
          quantity: item.quantity || 1,
          price: price,
          originalPrice: originalPrice,
          subtotal: itemSubtotal
        });
        
        // Cập nhật tổng tiền
        orderData.subtotal += itemSubtotal;
      });

      // Tính phí vận chuyển mặc định
      orderData.shipping = orderData.subtotal >= 500000 ? 0 : 30000;
      
      // Áp dụng mã giảm giá nếu có
      applyDiscount();
      
      // Tính tổng tiền cuối cùng
      calculateTotal();
    }

    /**
     * Áp dụng mã giảm giá
     */
    function applyDiscount() {
      if (!orderData.coupon) {
        orderData.discount = 0;
        return;
      }

      if (orderData.coupon.type === 'percent') {
        orderData.discount = Math.round(orderData.subtotal * orderData.coupon.value / 100);
      } else if (orderData.coupon.type === 'fixed') {
        orderData.discount = orderData.coupon.value;
      } else if (orderData.coupon.type === 'shipping') {
        orderData.discount = orderData.shipping;
        orderData.shipping = 0;
      }
    }

    /**
     * Tính tổng tiền cuối cùng
     */
    function calculateTotal() {
      orderData.total = orderData.subtotal + orderData.shipping - orderData.discount;
    }

    /**
     * Hiển thị giao diện thanh toán
     */
    function renderCheckoutUI() {
      const checkoutContent = document.getElementById('checkoutContent');
      
      // Tạo HTML cho danh sách sản phẩm
      let orderItemsHTML = '';
      orderData.items.forEach(item => {
        orderItemsHTML += `
          <div class="order-item">
            <img src="${item.image}" alt="${item.name}" class="order-item-image">
            <div class="order-item-details">
              <div class="order-item-title">${item.name}</div>
              ${item.variant ? `<div class="order-item-info">Phiên bản: ${item.variant}</div>` : ''}
              ${item.color ? `<div class="order-item-info">Màu sắc: ${item.color}</div>` : ''}
              <div class="order-item-info">Số lượng: ${item.quantity}</div>
              <div class="order-item-price">
                ${item.price.toLocaleString('vi-VN')}₫
                ${item.originalPrice ? `<span class="text-muted text-decoration-line-through ms-2" style="font-size: 0.85rem">${item.originalPrice.toLocaleString('vi-VN')}₫</span>` : ''}
              </div>
            </div>
          </div>
        `;
      });

      // Hiển thị coupon nếu có
      let couponHTML = '';
      if (orderData.coupon) {
        let couponDescription = '';
        
        if (orderData.coupon.type === 'percent') {
          couponDescription = `Giảm ${orderData.coupon.value}%`;
        } else if (orderData.coupon.type === 'fixed') {
          couponDescription = `Giảm ${orderData.coupon.value.toLocaleString('vi-VN')}₫`;
        } else if (orderData.coupon.type === 'shipping') {
          couponDescription = 'Miễn phí vận chuyển';
        }
        
        couponHTML = `
          <div class="coupon-applied">
            <div>
              <i class="fas fa-ticket-alt"></i>
              <span>Mã giảm giá: <strong>${orderData.coupon.code}</strong> (${couponDescription})</span>
            </div>
            <button type="button" class="btn btn-sm btn-link text-danger p-0" onclick="removeCoupon()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
      }

      // Tạo HTML cho trang thanh toán hoàn chỉnh
      checkoutContent.innerHTML = `
        <div class="row g-4">
          <div class="col-lg-8">
            <div class="checkout-form animate__animated animate__fadeIn">
              <h4 class="mb-4">Thông tin thanh toán</h4>
              <form id="checkoutForm" onsubmit="return false;">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="fullName" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="fullName" placeholder="Nhập họ và tên" required>
                    <div class="form-feedback" id="fullNameFeedback"></div>
                  </div>
                  <div class="col-md-6">
                    <label for="phone" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="phone" placeholder="Nhập số điện thoại" required>
                    <div class="form-feedback" id="phoneFeedback"></div>
                  </div>
                  <div class="col-md-6">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" placeholder="Nhập email">
                    <div class="form-feedback" id="emailFeedback"></div>
                  </div>
                  <div class="col-md-6">
                    <label for="city" class="form-label">Tỉnh/Thành phố <span class="text-danger">*</span></label>
                    <select class="form-select" id="city" required>
                      <option value="">Chọn tỉnh/thành phố</option>
                      <option value="Hà Nội">Hà Nội</option>
                      <option value="Hồ Chí Minh">Hồ Chí Minh</option>
                      <option value="Đà Nẵng">Đà Nẵng</option>
                      <option value="Hải Phòng">Hải Phòng</option>
                      <option value="Cần Thơ">Cần Thơ</option>
                      <option value="Khác">Tỉnh/TP khác</option>
                    </select>
                    <div class="form-feedback" id="cityFeedback"></div>
                  </div>
                  <div class="col-12">
                    <label for="address" class="form-label">Địa chỉ giao hàng <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="address" rows="3" placeholder="Nhập địa chỉ giao hàng đầy đủ" required></textarea>
                    <div class="form-feedback" id="addressFeedback"></div>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Phương thức vận chuyển</label>
                    <div class="shipping-options">
                      <div class="shipping-option active" onclick="selectShippingMethod('standard', this)">
                        <input type="radio" name="shipping" value="standard" checked class="shipping-option-radio">
                        <div class="shipping-option-info">
                          <div><strong>Giao hàng tiêu chuẩn</strong></div>
                          <div class="text-muted">Nhận hàng trong 3-5 ngày</div>
                        </div>
                        <div class="shipping-option-price">
                          ${orderData.subtotal >= 500000 ? 'Miễn phí' : '30.000₫'}
                        </div>
                      </div>
                      <div class="shipping-option" onclick="selectShippingMethod('express', this)">
                        <input type="radio" name="shipping" value="express" class="shipping-option-radio">
                        <div class="shipping-option-info">
                          <div><strong>Giao hàng nhanh</strong></div>
                          <div class="text-muted">Nhận hàng trong 1-2 ngày</div>
                        </div>
                        <div class="shipping-option-price">50.000₫</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 mt-4">
                    <label class="form-label">Phương thức thanh toán</label>
                    <div class="payment-method">
                      <div class="payment-option active" onclick="selectPaymentMethod('cod', this)">
                        <i class="fas fa-money-bill-wave"></i>
                        <div>Thanh toán khi nhận hàng (COD)</div>
                      </div>
                      <div class="payment-option" onclick="selectPaymentMethod('card', this)">
                        <i class="fas fa-credit-card"></i>
                        <div>Thẻ tín dụng/Thẻ ghi nợ</div>
                      </div>
                      <div class="payment-option" onclick="selectPaymentMethod('bank', this)">
                        <i class="fas fa-university"></i>
                        <div>Chuyển khoản ngân hàng</div>
                      </div>
                      <div class="payment-option" onclick="selectPaymentMethod('ewallet', this)">
                        <i class="fas fa-wallet"></i>
                        <div>Ví điện tử (Momo, ZaloPay, VNPay)</div>
                      </div>
                    </div>
                  </div>
                  <div id="paymentMethodDetails" class="col-12 mt-3" style="display: none;"></div>
                </div>
              </form>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="order-summary animate__animated animate__fadeIn">
              <h4>Tóm tắt đơn hàng</h4>
              <div class="order-items">
                ${orderItemsHTML}
              </div>
              
              <!-- Form áp dụng mã giảm giá -->
              <div class="mb-3">
                <div class="input-group">
                  <input type="text" class="form-control" id="couponInput" placeholder="Nhập mã giảm giá">
                  <button class="btn btn-outline-primary" type="button" onclick="applyCoupon()">Áp dụng</button>
                </div>
              </div>
              
              <!-- Hiển thị thông tin mã giảm giá -->
              <div id="couponContainer">
                ${couponHTML}
              </div>
              
              <!-- Tóm tắt đơn hàng -->
              <div class="summary-item mt-3">
                <span class="summary-label">Tạm tính (${orderData.items.length} sản phẩm):</span>
                <span class="summary-value">${orderData.subtotal.toLocaleString('vi-VN')}₫</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Phí vận chuyển:</span>
                <span class="summary-value" id="shippingFeeDisplay">
                  ${orderData.shipping === 0 ? 'Miễn phí' : `${orderData.shipping.toLocaleString('vi-VN')}₫`}
                </span>
              </div>
              ${orderData.discount > 0 ? `
              <div class="summary-item text-primary">
                <span class="summary-label">Giảm giá:</span>
                <span class="summary-value">-${orderData.discount.toLocaleString('vi-VN')}₫</span>
              </div>
              ` : ''}
              <div class="summary-divider"></div>
              <div class="summary-item">
                <span class="summary-label summary-total">Tổng cộng:</span>
                <span class="summary-value summary-total" id="totalDisplay">${orderData.total.toLocaleString('vi-VN')}₫</span>
              </div>
              <button class="btn btn-place-order mt-3" id="placeOrderBtn" onclick="placeOrder()">
                <i class="fas fa-check-circle me-2"></i> Đặt hàng
              </button>
            </div>
          </div>
        </div>
      `;

      // Add event handlers
      setupFormValidation();
      
      // Hiển thị thông tin phương thức thanh toán
      updatePaymentMethodDetails(selectedPaymentMethod);
    }

    /**
     * Chọn phương thức thanh toán
     */
    function selectPaymentMethod(method, element) {
      // Cập nhật lựa chọn trên giao diện
      document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('active'));
      element.classList.add('active');
      
      // Cập nhật biến lưu trữ phương thức được chọn
      selectedPaymentMethod = method;
      
      // Hiển thị thông tin bổ sung của phương thức thanh toán
      updatePaymentMethodDetails(method);
    }

    /**
     * Hiển thị thông tin chi tiết cho phương thức thanh toán
     */
    function updatePaymentMethodDetails(method) {
      const detailsContainer = document.getElementById('paymentMethodDetails');
      if (!detailsContainer) return;
      
      // Hiển thị container
      detailsContainer.style.display = 'block';
      
      // Tạo nội dung dựa trên phương thức
      let detailsHTML = '';
      
      switch (method) {
        case 'cod':
          detailsHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              Vui lòng chuẩn bị tiền mặt để thanh toán cho nhân viên giao hàng khi nhận hàng.
            </div>
          `;
          break;
          
        case 'card':
          detailsHTML = `
            <div class="card border p-3">
              <div class="mb-3">
                <label for="cardNumber" class="form-label">Số thẻ</label>
                <input type="text" class="form-control" id="cardNumber" placeholder="Nhập số thẻ">
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="expiryDate" class="form-label">Ngày hết hạn</label>
                  <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY">
                </div>
                <div class="col-md-6">
                  <label for="cvv" class="form-label">CVV</label>
                  <input type="text" class="form-control" id="cvv" placeholder="CVV">
                </div>
              </div>
              <div class="mb-0">
                <label for="cardName" class="form-label">Tên chủ thẻ</label>
                <input type="text" class="form-control" id="cardName" placeholder="Tên in trên thẻ">
              </div>
            </div>
          `;
          break;
          
        case 'bank':
          detailsHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <p class="mb-2">Thông tin tài khoản ngân hàng:</p>
              <ul class="mb-0 ps-3">
                <li>Ngân hàng: Vietcombank</li>
                <li>Số tài khoản: 0123456789</li>
                <li>Chủ tài khoản: CÔNG TY TNHH ANH EM RỌT</li>
                <li>Nội dung: [Mã đơn hàng sẽ được cung cấp sau khi đặt hàng]</li>
              </ul>
              <p class="mt-2 mb-0">Đơn hàng sẽ được xử lý sau khi chúng tôi nhận được thanh toán của bạn.</p>
            </div>
          `;
          break;
          
        case 'ewallet':
          detailsHTML = `
            <div class="mb-3">
              <label class="form-label">Chọn ví điện tử</label>
              <select class="form-select" id="ewalletType">
                <option value="momo">Momo</option>
                <option value="zalopay">ZaloPay</option>
                <option value="vnpay">VNPay</option>
              </select>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              Bạn sẽ được chuyển đến trang thanh toán của ví điện tử sau khi đặt hàng.
            </div>
          `;
          break;
      }
      
      // Cập nhật HTML
      detailsContainer.innerHTML = detailsHTML;
    }

    /**
     * Chọn phương thức vận chuyển
     */
    function selectShippingMethod(method, element) {
      // Cập nhật lựa chọn trên giao diện
      document.querySelectorAll('.shipping-option').forEach(opt => opt.classList.remove('active'));
      element.classList.add('active');
      
      // Đảm bảo radio được chọn
      const radio = element.querySelector('input[type="radio"]');
      if (radio) radio.checked = true;
      
      // Cập nhật biến lưu trữ phương thức được chọn
      selectedShippingMethod = method;
      
      // Cập nhật phí vận chuyển
      if (method === 'standard') {
        orderData.shipping = orderData.subtotal >= 500000 ? 0 : 30000;
      } else if (method === 'express') {
        orderData.shipping = 50000;
      }
      
      // Cập nhật lại giảm giá (trường hợp có mã miễn phí vận chuyển)
      if (orderData.coupon && orderData.coupon.type === 'shipping') {
        orderData.discount = orderData.shipping;
        orderData.shipping = 0;
      }
      
      // Tính lại tổng tiền
      calculateTotal();
      
      // Cập nhật hiển thị
      updateOrderSummary();
    }

    /**
     * Cập nhật hiển thị tóm tắt đơn hàng
     */
    function updateOrderSummary() {
      const shippingDisplay = document.getElementById('shippingFeeDisplay');
      if (shippingDisplay) {
        shippingDisplay.textContent = orderData.shipping === 0 ? 'Miễn phí' : `${orderData.shipping.toLocaleString('vi-VN')}₫`;
      }
      
      const totalDisplay = document.getElementById('totalDisplay');
      if (totalDisplay) {
        totalDisplay.textContent = `${orderData.total.toLocaleString('vi-VN')}₫`;
      }
    }

    /**
     * Áp dụng mã giảm giá
     */
    function applyCoupon() {
      const couponInput = document.getElementById('couponInput');
      if (!couponInput || !couponInput.value.trim()) {
        showToast('Vui lòng nhập mã giảm giá!', 'warning');
        return;
      }
      
      const couponCode = couponInput.value.trim().toUpperCase();
      
      // Mô phỏng kiểm tra mã giảm giá
      // Trong thực tế, nên gửi request đến server để xác thực
      const validCoupons = {
        'WELCOME10': { type: 'percent', value: 10 },
        'SALE20': { type: 'percent', value: 20 },
        'FREESHIP': { type: 'shipping', value: 0 },
        'GIAMGIA50K': { type: 'fixed', value: 50000 },
        'SINHVIEN': { type: 'percent', value: 15 }
      };
      
      if (validCoupons[couponCode]) {
        // Lưu thông tin mã giảm giá
        orderData.coupon = {
          code: couponCode,
          type: validCoupons[couponCode].type,
          value: validCoupons[couponCode].value
        };
        
        // Áp dụng giảm giá
        applyDiscount();
        
        // Tính lại tổng tiền
        calculateTotal();
        
        // Cập nhật localStorage (để đồng bộ với giỏ hàng)
        localStorage.setItem('couponCode', couponCode);
        localStorage.setItem('couponType', orderData.coupon.type);
        localStorage.setItem('couponValue', orderData.coupon.value);
        
        // Cập nhật giao diện
        renderCheckoutUI();
        
        // Hiển thị thông báo thành công
        showToast('Đã áp dụng mã giảm giá!', 'success');
      } else {
        // Hiển thị thông báo lỗi
        showToast('Mã giảm giá không hợp lệ hoặc đã hết hạn!', 'danger');
      }
      
      // Xóa giá trị input
      couponInput.value = '';
    }

    /**
     * Xóa mã giảm giá
     */
    function removeCoupon() {
      // Xóa thông tin mã giảm giá
      orderData.coupon = null;
      orderData.discount = 0;
      
      // Xóa khỏi localStorage
      localStorage.removeItem('couponCode');
      localStorage.removeItem('couponType');
      localStorage.removeItem('couponValue');
      
      // Tính lại tổng tiền
      calculateTotal();
      
      // Cập nhật giao diện
      renderCheckoutUI();
      
      // Hiển thị thông báo
      showToast('Đã xóa mã giảm giá!', 'info');
    }

    /**
     * Thiết lập xác thực form
     */
    function setupFormValidation() {
      const fullNameInput = document.getElementById('fullName');
      const phoneInput = document.getElementById('phone');
      const emailInput = document.getElementById('email');
      const addressInput = document.getElementById('address');
      const citySelect = document.getElementById('city');
      
      // Xác thực khi input thay đổi
      if (fullNameInput) {
        fullNameInput.addEventListener('input', function() {
          validateFullName(this);
        });
      }
      
      if (phoneInput) {
        phoneInput.addEventListener('input', function() {
          validatePhone(this);
        });
      }
      
      if (emailInput) {
        emailInput.addEventListener('input', function() {
          validateEmail(this);
        });
      }
      
      if (addressInput) {
        addressInput.addEventListener('input', function() {
          validateAddress(this);
        });
      }
      
      if (citySelect) {
        citySelect.addEventListener('change', function() {
          validateCity(this);
        });
      }
    }

    /**
     * Xác thực họ tên
     */
    function validateFullName(input) {
      const feedback = document.getElementById('fullNameFeedback');
      if (!feedback) return true;
      
      if (!input.value.trim()) {
        feedback.textContent = 'Vui lòng nhập họ và tên';
        input.classList.add('is-invalid');
        return false;
      } else if (input.value.trim().length < 3) {
        feedback.textContent = 'Họ và tên phải có ít nhất 3 ký tự';
        input.classList.add('is-invalid');
        return false;
      } else {
        feedback.textContent = '';
        input.classList.remove('is-invalid');
        return true;
      }
    }

    /**
     * Xác thực số điện thoại
     */
    function validatePhone(input) {
      const feedback = document.getElementById('phoneFeedback');
      if (!feedback) return true;
      
      const phonePattern = /^(0|\+84|84)[3|5|7|8|9][0-9]{8}$/;
      
      if (!input.value.trim()) {
        feedback.textContent = 'Vui lòng nhập số điện thoại';
        input.classList.add('is-invalid');
        return false;
      } else if (!phonePattern.test(input.value.trim())) {
        feedback.textContent = 'Số điện thoại không hợp lệ';
        input.classList.add('is-invalid');
        return false;
      } else {
        feedback.textContent = '';
        input.classList.remove('is-invalid');
        return true;
      }
    }

    /**
     * Xác thực email
     */
    function validateEmail(input) {
      const feedback = document.getElementById('emailFeedback');
      if (!feedback) return true;
      
      // Nếu email trống, cho phép (vì trường này không bắt buộc)
      if (!input.value.trim()) {
        feedback.textContent = '';
        input.classList.remove('is-invalid');
        return true;
      }
      
      const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      
      if (!emailPattern.test(input.value.trim())) {
        feedback.textContent = 'Email không hợp lệ';
        input.classList.add('is-invalid');
        return false;
      } else {
        feedback.textContent = '';
        input.classList.remove('is-invalid');
        return true;
      }
    }

    /**
     * Xác thực địa chỉ
     */
    function validateAddress(input) {
      const feedback = document.getElementById('addressFeedback');
      if (!feedback) return true;
      
      if (!input.value.trim()) {
        feedback.textContent = 'Vui lòng nhập địa chỉ giao hàng';
        input.classList.add('is-invalid');
        return false;
      } else if (input.value.trim().length < 10) {
        feedback.textContent = 'Vui lòng nhập địa chỉ đầy đủ và chi tiết hơn';
        input.classList.add('is-invalid');
        return false;
      } else {
        feedback.textContent = '';
        input.classList.remove('is-invalid');
        return true;
      }
    }

    /**
     * Xác thực thành phố
     */
    function validateCity(select) {
      const feedback = document.getElementById('cityFeedback');
      if (!feedback) return true;
      
      if (!select.value) {
        feedback.textContent = 'Vui lòng chọn tỉnh/thành phố';
        select.classList.add('is-invalid');
        return false;
      } else {
        feedback.textContent = '';
        select.classList.remove('is-invalid');
        return true;
      }
    }

    /**
     * Xác thực toàn bộ form
     */
    function validateCheckoutForm() {
      const fullNameInput = document.getElementById('fullName');
      const phoneInput = document.getElementById('phone');
      const emailInput = document.getElementById('email');
      const addressInput = document.getElementById('address');
      const citySelect = document.getElementById('city');
      
      const isFullNameValid = fullNameInput ? validateFullName(fullNameInput) : true;
      const isPhoneValid = phoneInput ? validatePhone(phoneInput) : true;
      const isEmailValid = emailInput ? validateEmail(emailInput) : true;
      const isAddressValid = addressInput ? validateAddress(addressInput) : true;
      const isCityValid = citySelect ? validateCity(citySelect) : true;
      
      return isFullNameValid && isPhoneValid && isEmailValid && isAddressValid && isCityValid;
    }

    /**
     * Xử lý đặt hàng
     */
    function placeOrder() {
      // Ngăn chặn đặt hàng nhiều lần
      if (orderPlaced) {
        return;
      }
      
      // Kiểm tra xác thực form
      if (!validateCheckoutForm()) {
        showToast('Vui lòng điền đầy đủ thông tin!', 'warning');
        return;
      }
      
      // Lấy thông tin form
      const fullName = document.getElementById('fullName').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const address = document.getElementById('address').value.trim();
      const city = document.getElementById('city').value;
      
      // Lưu thông tin khách hàng
      const customerInfo = { fullName, phone, email, address, city };
      localStorage.setItem('customerInfo', JSON.stringify(customerInfo));
      
      // Hiển thị trạng thái đang xử lý
      const orderButton = document.getElementById('placeOrderBtn');
      if (orderButton) {
        orderButton.disabled = true;
        orderButton.innerHTML = `
          <span class="btn-spinner me-2"></span>
          Đang xử lý...
        `;
      }
      
      // Đánh dấu đã đặt hàng
      orderPlaced = true;
      
      // Mô phỏng quá trình đặt hàng (trong thực tế sẽ gửi request đến server)
      setTimeout(() => {
        // Tạo mã đơn hàng ngẫu nhiên
        const orderId = 'AER' + Date.now().toString().slice(-8);
        
        // Xóa giỏ hàng
        localStorage.removeItem('cart');
        localStorage.removeItem('checkoutCart');
        localStorage.removeItem('couponCode');
        localStorage.removeItem('couponType');
        localStorage.removeItem('couponValue');
        
        // Hiển thị thông báo đặt hàng thành công
        const checkoutContent = document.getElementById('checkoutContent');
        if (checkoutContent) {
          checkoutContent.innerHTML = `
            <div class="order-success animate__animated animate__fadeIn">
              <i class="fas fa-check-circle"></i>
              <h2>Đặt hàng thành công!</h2>
              <p>Cảm ơn bạn đã mua sắm tại Anh Em Rọt Store.</p>
              <p>Mã đơn hàng của bạn là: <span class="order-id">${orderId}</span></p>
              <p>Chúng tôi sẽ liên hệ với bạn sớm để xác nhận đơn hàng.</p>
              
              <div class="customer-info text-start my-4">
                <h5>Thông tin đơn hàng:</h5>
                <p><strong>Người nhận:</strong> ${fullName}</p>
                <p><strong>Số điện thoại:</strong> ${phone}</p>
                <p><strong>Địa chỉ:</strong> ${address}, ${city}</p>
                <p><strong>Phương thức thanh toán:</strong> ${getPaymentMethodText(selectedPaymentMethod)}</p>
                <p><strong>Tổng tiền:</strong> ${orderData.total.toLocaleString('vi-VN')}₫</p>
              </div>
              
              <div class="mt-4">
                <a href="index.html" class="btn btn-shop-now">
                  <i class="fas fa-home me-2"></i>Về trang chủ
                </a>
                <a href="product.html" class="btn btn-outline-primary ms-3">
                  <i class="fas fa-shopping-bag me-2"></i>Tiếp tục mua sắm
                </a>
              </div>
            </div>
          `;
        }
      }, 2000);
    }

    /**
     * Lấy tên phương thức thanh toán
     */
    function getPaymentMethodText(method) {
      switch (method) {
        case 'cod':
          return 'Thanh toán khi nhận hàng (COD)';
        case 'card':
          return 'Thẻ tín dụng/Thẻ ghi nợ';
        case 'bank':
          return 'Chuyển khoản ngân hàng';
        case 'ewallet':
          const ewalletType = document.getElementById('ewalletType');
          const wallet = ewalletType ? ewalletType.value : 'momo';
          
          switch (wallet) {
            case 'momo':
              return 'Ví MoMo';
            case 'zalopay':
              return 'ZaloPay';
            case 'vnpay':
              return 'VNPay';
            default:
              return 'Ví điện tử';
          }
        default:
          return 'Không xác định';
      }
    }

    /**
     * Hiển thị thông báo toast
     */
    function showToast(message, type = 'success') {
      // Tạo container cho toast nếu chưa tồn tại
      let toastContainer = document.querySelector('.toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container';
        document.body.appendChild(toastContainer);
      }
      
      // Tạo ID duy nhất cho toast
      const toastId = 'toast-' + Date.now();
      
      // Chọn icon và màu sắc dựa vào loại thông báo
      let icon = 'info-circle';
      let bgColor = 'primary';
      
      if (type === 'success') {
        icon = 'check-circle';
        bgColor = 'success';
      } else if (type === 'warning') {
        icon = 'exclamation-triangle';
        bgColor = 'warning';
      } else if (type === 'danger') {
        icon = 'exclamation-circle';
        bgColor = 'danger';
      }
      
      // Tạo HTML cho toast
      const toastHtml = `
        <div id="${toastId}" class="toast show align-items-center text-white bg-${bgColor} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              <i class="fas fa-${icon} me-2"></i>
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Đóng" onclick="closeToast('${toastId}')"></button>
          </div>
        </div>
      `;
      
      // Thêm toast vào container
      toastContainer.insertAdjacentHTML('beforeend', toastHtml);
      
      // Tự động đóng toast sau 3 giây
      setTimeout(() => {
        closeToast(toastId);
      }, 3000);
    }

    /**
     * Đóng toast theo ID
     */
    function closeToast(toastId) {
      const toastElement = document.getElementById(toastId);
      if (!toastElement) return;
      
      // Thêm hiệu ứng fade out
      toastElement.style.opacity = '0';
      toastElement.style.transition = 'opacity 0.3s ease';
      
      // Xóa toast sau khi hiệu ứng hoàn thành
      setTimeout(() => {
        toastElement.remove();
      }, 300);
    }
  </script>
</body>
</html>